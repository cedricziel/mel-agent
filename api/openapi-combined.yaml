---
openapi: 3.0.3
info:
  title: MEL Agent API
  description: AI Agents SaaS platform API with visual workflow builder
  version: 1.0.0
  contact:
    name: MEL Agent Team
    url: https://github.com/cedricziel/mel-agent
  license:
    name: AGPL-3.0
    url: https://www.gnu.org/licenses/agpl-3.0.html

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://api.mel-agent.com
    description: Production server

paths:
  /api/health:
    get:
      summary: Health check endpoint
      operationId: getHealth
      tags:
        - System
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'


  /api/workflows:
    get:
      summary: List all workflows
      operationId: listWorkflows
      tags:
        - Workflows
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of workflows
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowList'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: Create a new workflow
      operationId: createWorkflow
      tags:
        - Workflows
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWorkflowRequest'
      responses:
        '201':
          description: Workflow created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workflows/{id}:
    get:
      summary: Get workflow by ID
      operationId: getWorkflow
      tags:
        - Workflows
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Workflow details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      summary: Update workflow
      operationId: updateWorkflow
      tags:
        - Workflows
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWorkflowRequest'
      responses:
        '200':
          description: Workflow updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: Delete workflow
      operationId: deleteWorkflow
      tags:
        - Workflows
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Workflow deleted successfully
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workflows/{id}/execute:
    post:
      summary: Execute a workflow
      operationId: executeWorkflow
      tags:
        - Workflows
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                input:
                  type: object
                  additionalProperties: true
      responses:
        '200':
          description: Workflow execution started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowExecution'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workflow-runs:
    get:
      summary: List workflow runs
      operationId: listWorkflowRuns
      tags:
        - WorkflowRuns
      parameters:
        - name: workflow_id
          in: query
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, running, completed, failed]
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of workflow runs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowRunList'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workflow-runs/{id}:
    get:
      summary: Get workflow run details
      operationId: getWorkflowRun
      tags:
        - WorkflowRuns
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Workflow run details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowRun'
        '404':
          description: Workflow run not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workflow-runs/{id}/steps:
    get:
      summary: Get workflow run steps
      operationId: getWorkflowRunSteps
      tags:
        - WorkflowRuns
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of workflow steps
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WorkflowStep'
        '404':
          description: Workflow run not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/node-types:
    get:
      summary: List available node types
      operationId: listNodeTypes
      tags:
        - NodeTypes
      parameters:
        - name: kind
          in: query
          description: Filter by node kind (can be comma-separated)
          schema:
            type: string
            example: model,memory,action,tool,trigger
      responses:
        '200':
          description: List of node types
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NodeType'

  /api/connections:
    get:
      summary: List connections
      operationId: listConnections
      tags:
        - Connections
      responses:
        '200':
          description: List of connections
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Connection'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: Create a connection
      operationId: createConnection
      tags:
        - Connections
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateConnectionRequest'
      responses:
        '201':
          description: Connection created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Connection'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/connections/{id}:
    get:
      summary: Get connection by ID
      operationId: getConnection
      tags:
        - Connections
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Connection details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Connection'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      summary: Update connection
      operationId: updateConnection
      tags:
        - Connections
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateConnectionRequest'
      responses:
        '200':
          description: Connection updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Connection'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: Delete connection
      operationId: deleteConnection
      tags:
        - Connections
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Connection deleted
        '404':
          description: Connection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/triggers:
    get:
      summary: List triggers
      operationId: listTriggers
      tags:
        - Triggers
      responses:
        '200':
          description: List of triggers
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Trigger'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: Create a trigger
      operationId: createTrigger
      tags:
        - Triggers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTriggerRequest'
      responses:
        '201':
          description: Trigger created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trigger'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/triggers/{id}:
    get:
      summary: Get trigger by ID
      operationId: getTrigger
      tags:
        - Triggers
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Trigger details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trigger'
        '404':
          description: Trigger not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      summary: Update trigger
      operationId: updateTrigger
      tags:
        - Triggers
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTriggerRequest'
      responses:
        '200':
          description: Trigger updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trigger'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Trigger not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: Delete trigger
      operationId: deleteTrigger
      tags:
        - Triggers
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Trigger deleted
        '404':
          description: Trigger not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workers:
    get:
      summary: List all workers
      operationId: listWorkers
      tags:
        - Workers
      responses:
        '200':
          description: List of workers
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Worker'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: Register a new worker
      operationId: registerWorker
      tags:
        - Workers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterWorkerRequest'
      responses:
        '201':
          description: Worker registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Worker'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workers/{id}:
    delete:
      summary: Unregister a worker
      operationId: unregisterWorker
      tags:
        - Workers
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Worker unregistered successfully
        '404':
          description: Worker not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workers/{id}/heartbeat:
    put:
      summary: Update worker heartbeat
      operationId: updateWorkerHeartbeat
      tags:
        - Workers
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Heartbeat updated successfully
        '404':
          description: Worker not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workers/{id}/claim-work:
    post:
      summary: Claim work items
      operationId: claimWork
      tags:
        - Workers
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                maxItems:
                  type: integer
                  minimum: 1
                  maximum: 100
      responses:
        '200':
          description: Work items claimed
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WorkItem'

  /api/workers/{id}/complete-work/{itemId}:
    post:
      summary: Complete a work item
      operationId: completeWork
      tags:
        - Workers
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: itemId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                result:
                  type: object
                  additionalProperties: true
                error:
                  type: string
      responses:
        '200':
          description: Work item completed

  /api/workflows/{workflowId}/nodes:
    get:
      summary: List all nodes in a workflow
      operationId: listWorkflowNodes
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of workflow nodes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WorkflowNode'
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: Create a new node in workflow
      operationId: createWorkflowNode
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWorkflowNodeRequest'
      responses:
        '201':
          description: Workflow node created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowNode'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workflows/{workflowId}/nodes/{nodeId}:
    get:
      summary: Get specific workflow node
      operationId: getWorkflowNode
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: nodeId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Workflow node details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowNode'
        '404':
          description: Workflow or node not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      summary: Update workflow node
      operationId: updateWorkflowNode
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: nodeId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWorkflowNodeRequest'
      responses:
        '200':
          description: Workflow node updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowNode'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Workflow or node not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: Delete workflow node
      operationId: deleteWorkflowNode
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: nodeId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Workflow node deleted successfully
        '404':
          description: Workflow or node not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workflows/{workflowId}/edges:
    get:
      summary: List all edges in a workflow
      operationId: listWorkflowEdges
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of workflow edges
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WorkflowEdge'
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: Create a new edge in workflow
      operationId: createWorkflowEdge
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWorkflowEdgeRequest'
      responses:
        '201':
          description: Workflow edge created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowEdge'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workflows/{workflowId}/edges/{edgeId}:
    delete:
      summary: Delete workflow edge
      operationId: deleteWorkflowEdge
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: edgeId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Workflow edge deleted successfully
        '404':
          description: Workflow or edge not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workflows/{workflowId}/layout:
    post:
      summary: Auto-layout workflow nodes
      operationId: autoLayoutWorkflow
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Layout updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowLayoutResult'
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workflows/{workflowId}/draft:
    get:
      summary: Get current draft for a workflow
      operationId: getWorkflowDraft
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Workflow draft
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowDraft'
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      summary: Update workflow draft with auto-persistence
      operationId: updateWorkflowDraft
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWorkflowDraftRequest'
      responses:
        '200':
          description: Draft updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowDraft'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workflows/{workflowId}/draft/nodes/{nodeId}/test:
    post:
      summary: Test a single node in draft context
      operationId: testWorkflowDraftNode
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: nodeId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecuteWorkflowRequest'
      responses:
        '200':
          description: Node test result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NodeTestResult'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Workflow or node not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workflows/{workflowId}/versions:
    get:
      summary: List all versions of a workflow
      operationId: listWorkflowVersions
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of workflow versions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowVersionList'
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: Create a new workflow version
      operationId: createWorkflowVersion
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWorkflowVersionRequest'
      responses:
        '201':
          description: Version created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowVersion'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workflows/{workflowId}/versions/latest:
    get:
      summary: Get latest version of a workflow
      operationId: getLatestWorkflowVersion
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Latest workflow version
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowVersion'
        '404':
          description: Workflow not found or no versions exist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/workflows/{workflowId}/versions/{versionNumber}/deploy:
    post:
      summary: Deploy a specific workflow version
      operationId: deployWorkflowVersion
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: versionNumber
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Version deployed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowVersion'
        '404':
          description: Workflow or version not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/credentials:
    get:
      summary: List credentials for selection in nodes
      operationId: listCredentials
      tags:
        - Credentials
      parameters:
        - name: credential_type
          in: query
          description: Filter by credential type
          schema:
            type: string
      responses:
        '200':
          description: List of credentials
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Credential'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /webhooks/{token}:
    post:
      summary: Webhook endpoint
      operationId: handleWebhook
      tags:
        - Webhooks
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookPayload'
      responses:
        '200':
          description: Webhook processed
        '404':
          description: Webhook not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/integrations:
    get:
      summary: List available integrations
      operationId: listIntegrations
      tags:
        - Integrations
      responses:
        '200':
          description: List of available integrations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Integration'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/credential-types:
    get:
      summary: List credential type definitions
      operationId: listCredentialTypes
      tags:
        - CredentialTypes
      responses:
        '200':
          description: List of credential types
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CredentialType'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/credential-types/{type}/schema:
    get:
      summary: Get JSON schema for credential type
      operationId: getCredentialTypeSchema
      tags:
        - CredentialTypes
      parameters:
        - name: type
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Credential type schema
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CredentialTypeSchema'
        '404':
          description: Credential type not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/credential-types/{type}/test:
    post:
      summary: Test credentials for a specific type
      operationId: testCredentials
      tags:
        - CredentialTypes
      parameters:
        - name: type
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                credentials:
                  type: object
                  additionalProperties: true
      responses:
        '200':
          description: Credential test result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CredentialTestResult'
        '400':
          description: Invalid credentials or test failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Credential type not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/node-types/{type}/parameters/{parameter}/options:
    get:
      summary: Get dynamic options for node parameters
      operationId: getNodeParameterOptions
      tags:
        - NodeTypes
      parameters:
        - name: type
          in: path
          required: true
          schema:
            type: string
        - name: parameter
          in: path
          required: true
          schema:
            type: string
        - name: context
          in: query
          description: Context for dynamic option generation
          schema:
            type: string
      responses:
        '200':
          description: Dynamic parameter options
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NodeParameterOptions'
        '404':
          description: Node type or parameter not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/extensions:
    get:
      summary: List available extensions and plugins
      operationId: listExtensions
      tags:
        - System
      responses:
        '200':
          description: List of available extensions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Extension'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/assistant/chat:
    post:
      summary: Chat with AI assistant
      operationId: assistantChat
      tags:
        - Assistant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssistantChatRequest'
      responses:
        '200':
          description: Assistant response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssistantChatResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    WebhookPayload:
      description: Any valid JSON payload for webhook
      anyOf:
        - type: object
          additionalProperties: true
          description: JSON object with any properties
        - type: array
          items:
            anyOf:
              - type: object
                additionalProperties: true
              - type: array
                items: {}
              - type: string
                nullable: true
              - type: number
              - type: integer
              - type: boolean
          description: JSON array containing any valid JSON values
        - type: string
          description: JSON string value
        - type: number
          description: JSON number (including decimals)
        - type: integer
          description: JSON integer value
        - type: boolean
          description: JSON boolean (true/false)

    AssistantChatRequest:
      type: object
      required:
        - messages
      properties:
        messages:
          type: array
          items:
            $ref: '#/components/schemas/ChatMessage'
          description: Array of chat messages
        workflow_id:
          type: string
          format: uuid
          description: Optional workflow ID for context-aware assistance

    AssistantChatResponse:
      type: object
      properties:
        id:
          type: string
          description: Response ID
        object:
          type: string
          description: Object type (e.g., "chat.completion")
        created:
          type: integer
          description: Unix timestamp
        model:
          type: string
          description: Model used
        choices:
          type: array
          items:
            $ref: '#/components/schemas/ChatChoice'
          description: Array of response choices
        usage:
          $ref: '#/components/schemas/ChatUsage'

    Extension:
      type: object
      required:
        - id
        - version
        - categories
      properties:
        id:
          type: string
          description: Unique plugin identifier
        version:
          type: string
          description: Semver-compliant version string
        categories:
          type: array
          items:
            type: string
          description: Extension types provided (e.g. "node", "trigger")
        params:
          type: array
          items:
            $ref: '#/components/schemas/ParamSpec'
          description: Parameter schema for configuration/UI
        ui_component:
          type: string
          description: Optional path or URL to React bundle

    ParamSpec:
      type: object
      required:
        - name
        - type
      properties:
        name:
          type: string
          description: Key name
        label:
          type: string
          description: User-facing label
        type:
          type: string
          description: Data type (e.g. "string", "number", "enum")
        required:
          type: boolean
          description: Must be provided
        default:
          description: Default value
        group:
          type: string
          description: UI grouping
        visibility_condition:
          type: string
          description: Conditional display expression
        options:
          type: array
          items:
            type: string
          description: Enum options
        validators:
          type: array
          items:
            $ref: '#/components/schemas/ValidatorSpec'
          description: Validation rules
        description:
          type: string
          description: Help text

    ValidatorSpec:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          description: Validator type (e.g. "notEmpty", "regex")
        params:
          type: object
          description: Parameters for the validator

    ChatMessage:
      type: object
      required:
        - role
        - content
      properties:
        role:
          type: string
          enum: [system, user, assistant, function]
          description: Message role
        content:
          type: string
          description: Message content
        name:
          type: string
          description: Function name (for function role)
        function_call:
          $ref: '#/components/schemas/FunctionCall'

    ChatChoice:
      type: object
      properties:
        index:
          type: integer
          description: Choice index
        message:
          $ref: '#/components/schemas/ChatMessage'
        finish_reason:
          type: string
          enum: [stop, length, function_call]
          description: Reason for finishing

    FunctionCall:
      type: object
      properties:
        name:
          type: string
          description: Function name
        arguments:
          type: string
          description: Function arguments as JSON string

    ChatUsage:
      type: object
      properties:
        prompt_tokens:
          type: integer
          description: Tokens used in prompt
        completion_tokens:
          type: integer
          description: Tokens used in completion
        total_tokens:
          type: integer
          description: Total tokens used


    Workflow:
      type: object
      required:
        - id
        - name
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        definition:
          $ref: '#/components/schemas/WorkflowDefinition'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateWorkflowRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
        description:
          type: string
        definition:
          $ref: '#/components/schemas/WorkflowDefinition'

    UpdateWorkflowRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        definition:
          $ref: '#/components/schemas/WorkflowDefinition'

    WorkflowList:
      type: object
      required:
        - workflows
        - total
        - page
        - limit
      properties:
        workflows:
          type: array
          items:
            $ref: '#/components/schemas/Workflow'
        total:
          type: integer
        page:
          type: integer
        limit:
          type: integer

    WorkflowDefinition:
      type: object
      properties:
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowNode'
        edges:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowEdge'

    WorkflowNode:
      type: object
      required:
        - id
        - name
        - type
        - config
      properties:
        id:
          type: string
        name:
          type: string
        type:
          type: string
        config:
          type: object
          additionalProperties: true

    WorkflowEdge:
      type: object
      required:
        - id
        - source
        - target
      properties:
        id:
          type: string
        source:
          type: string
        target:
          type: string
        sourceOutput:
          type: string
        targetInput:
          type: string

    WorkflowDraft:
      type: object
      properties:
        workflow_id:
          type: string
          format: uuid
        definition:
          $ref: '#/components/schemas/WorkflowDefinition'
        updated_at:
          type: string
          format: date-time

    UpdateWorkflowDraftRequest:
      type: object
      properties:
        definition:
          $ref: '#/components/schemas/WorkflowDefinition'

    WorkflowVersion:
      type: object
      properties:
        id:
          type: string
          format: uuid
        workflow_id:
          type: string
          format: uuid
        version_number:
          type: integer
        name:
          type: string
        description:
          type: string
        definition:
          $ref: '#/components/schemas/WorkflowDefinition'
        is_current:
          type: boolean
        created_at:
          type: string
          format: date-time

    CreateWorkflowVersionRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
        description:
          type: string
        definition:
          $ref: '#/components/schemas/WorkflowDefinition'

    WorkflowVersionList:
      type: object
      required:
        - versions
        - total
      properties:
        versions:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowVersion'
        total:
          type: integer

    ExecuteWorkflowRequest:
      type: object
      properties:
        input:
          type: object
          additionalProperties: true

    WorkflowExecution:
      type: object
      properties:
        id:
          type: string
          format: uuid
        workflow_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, running, completed, failed]
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        result:
          type: object
          additionalProperties: true
        error:
          type: string

    WorkflowRun:
      type: object
      properties:
        id:
          type: string
          format: uuid
        workflow_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, running, completed, failed]
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        context:
          type: object
          additionalProperties: true
        error:
          type: string

    WorkflowRunList:
      type: object
      required:
        - runs
        - total
        - page
        - limit
      properties:
        runs:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowRun'
        total:
          type: integer
        page:
          type: integer
        limit:
          type: integer

    WorkflowStep:
      type: object
      properties:
        id:
          type: string
          format: uuid
        run_id:
          type: string
          format: uuid
        node_id:
          type: string
        status:
          type: string
          enum: [pending, running, completed, failed, skipped]
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        input:
          type: object
          additionalProperties: true
        output:
          type: object
          additionalProperties: true
        error:
          type: string

    NodeType:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        kinds:
          type: array
          items:
            type: string
            enum: [action, model, memory, tool, trigger]
        inputs:
          type: array
          items:
            $ref: '#/components/schemas/NodeInput'
        outputs:
          type: array
          items:
            $ref: '#/components/schemas/NodeOutput'

    NodeInput:
      type: object
      properties:
        name:
          type: string
        type:
          type: string
        required:
          type: boolean
        description:
          type: string

    NodeOutput:
      type: object
      properties:
        name:
          type: string
        type:
          type: string
        description:
          type: string

    Connection:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        integration_id:
          type: string
          format: uuid
        name:
          type: string
        secret:
          type: object
          additionalProperties: true
        config:
          type: object
          additionalProperties: true
        usage_limit_month:
          type: integer
        is_default:
          type: boolean
        created_at:
          type: string
          format: date-time
        last_validated:
          type: string
          format: date-time
        status:
          type: string
          enum: [valid, invalid, expired]

    CreateConnectionRequest:
      type: object
      required:
        - name
        - integration_id
      properties:
        name:
          type: string
        integration_id:
          type: string
          format: uuid
        secret:
          type: object
          additionalProperties: true
        config:
          type: object
          additionalProperties: true
        usage_limit_month:
          type: integer
        is_default:
          type: boolean

    UpdateConnectionRequest:
      type: object
      properties:
        name:
          type: string
        secret:
          type: object
          additionalProperties: true
        config:
          type: object
          additionalProperties: true
        usage_limit_month:
          type: integer
        is_default:
          type: boolean
        status:
          type: string
          enum: [valid, invalid, expired]

    Trigger:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        type:
          type: string
          enum: [schedule, webhook]
        workflow_id:
          type: string
          format: uuid
        config:
          type: object
          additionalProperties: true
        enabled:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateTriggerRequest:
      type: object
      required:
        - name
        - type
        - workflow_id
      properties:
        name:
          type: string
        type:
          type: string
          enum: [schedule, webhook]
        workflow_id:
          type: string
          format: uuid
        config:
          type: object
          additionalProperties: true
        enabled:
          type: boolean
          default: true

    UpdateTriggerRequest:
      type: object
      properties:
        name:
          type: string
        config:
          type: object
          additionalProperties: true
        enabled:
          type: boolean

    Worker:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        status:
          type: string
          enum: [active, inactive]
        last_heartbeat:
          type: string
          format: date-time
        concurrency:
          type: integer
        registered_at:
          type: string
          format: date-time

    RegisterWorkerRequest:
      type: object
      required:
        - id
      properties:
        id:
          type: string
        name:
          type: string
        concurrency:
          type: integer
          minimum: 1
          default: 5

    WorkItem:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
        payload:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time

    NodeTestResult:
      type: object
      properties:
        success:
          type: boolean
        output:
          type: object
          additionalProperties: true
        error:
          type: string
        execution_time:
          type: number
        logs:
          type: array
          items:
            type: string


    CreateWorkflowNodeRequest:
      type: object
      required:
        - id
        - name
        - type
        - config
      properties:
        id:
          type: string
        name:
          type: string
        type:
          type: string
        config:
          type: object
          additionalProperties: true
        position:
          type: object
          properties:
            x:
              type: number
            y:
              type: number

    UpdateWorkflowNodeRequest:
      type: object
      properties:
        name:
          type: string
        config:
          type: object
          additionalProperties: true
        position:
          type: object
          properties:
            x:
              type: number
            y:
              type: number

    CreateWorkflowEdgeRequest:
      type: object
      required:
        - id
        - source
        - target
      properties:
        id:
          type: string
        source:
          type: string
        target:
          type: string
        sourceOutput:
          type: string
        targetInput:
          type: string

    WorkflowLayoutResult:
      type: object
      properties:
        nodes:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              position:
                type: object
                properties:
                  x:
                    type: number
                  y:
                    type: number

    Credential:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        type:
          type: string
        description:
          type: string
        created_at:
          type: string
          format: date-time
        last_used:
          type: string
          format: date-time
        status:
          type: string
          enum: [valid, invalid, expired]

    Integration:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        type:
          type: string
        status:
          type: string
          enum: [active, inactive]
        capabilities:
          type: array
          items:
            type: string
        credential_type:
          type: string
          description: Type of credential required for this integration
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CredentialType:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        schema:
          type: object
          additionalProperties: true
        required_fields:
          type: array
          items:
            type: string
        test_endpoint:
          type: string

    CredentialTypeSchema:
      type: object
      properties:
        type:
          type: string
        properties:
          type: object
          additionalProperties: true
        required:
          type: array
          items:
            type: string
        title:
          type: string
        description:
          type: string

    CredentialTestResult:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        error:
          type: string
        details:
          type: object
          additionalProperties: true

    NodeExecutionResult:
      type: object
      properties:
        success:
          type: boolean
        output:
          type: object
          additionalProperties: true
        error:
          type: string
        execution_time:
          type: number
        logs:
          type: array
          items:
            type: string
        node_id:
          type: string
        agent_id:
          type: string
          format: uuid

    NodeParameterOptions:
      type: object
      properties:
        options:
          type: array
          items:
            type: object
            properties:
              value:
                type: string
              label:
                type: string
              description:
                type: string
        dynamic:
          type: boolean
        context_dependent:
          type: boolean

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        code:
          type: integer

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

security:
  - BearerAuth: []
  - ApiKeyAuth: []

tags:
  - name: System
    description: System health and status endpoints
  - name: Workflows
    description: Workflow management endpoints
  - name: WorkflowRuns
    description: Workflow execution management
  - name: NodeTypes
    description: Node type discovery endpoints
  - name: Connections
    description: Integration connection management
  - name: Triggers
    description: Workflow trigger management
  - name: Workers
    description: Worker management endpoints
  - name: Webhooks
    description: External webhook handlers
  - name: Credentials
    description: Credential management for node connections
  - name: Integrations
    description: Available integration services
  - name: CredentialTypes
    description: Credential type definitions and schemas
